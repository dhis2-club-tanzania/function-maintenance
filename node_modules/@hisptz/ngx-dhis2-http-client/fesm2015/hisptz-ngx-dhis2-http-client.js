import { Injectable, defineInjectable, inject } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { of, forkJoin, throwError } from 'rxjs';
import { tap, catchError, map, switchMap, mergeMap } from 'rxjs/internal/operators';

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
class ManifestService {
    /**
     * @param {?} httpClient
     */
    constructor(httpClient) {
        this.httpClient = httpClient;
        this._defaultRootUrl = '../../../';
        this._manifestLoaded = false;
    }
    /**
     * @return {?}
     */
    getManifest() {
        return this._manifestLoaded ? of(this._manifest) : this.httpClient.get('manifest.webapp').pipe(catchError(() => {
            console.warn('Manifest file could not be loaded, default options have been used instead');
            return of(null);
        }), tap((manifest) => {
            this._manifest = manifest;
            this._manifestLoaded = true;
        }));
    }
    /**
     * @return {?}
     */
    getRootUrl() {
        return this.getManifest().pipe(map((manifest) => {
            if (!manifest) {
                return this._defaultRootUrl;
            }
            return manifest.activities && manifest.activities.dhis && manifest.activities.dhis.href ?
                manifest.activities.dhis.href : this._defaultRootUrl;
        }));
    }
}
ManifestService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] },
];
/** @nocollapse */
ManifestService.ctorParameters = () => [
    { type: HttpClient }
];
/** @nocollapse */ ManifestService.ngInjectableDef = defineInjectable({ factory: function ManifestService_Factory() { return new ManifestService(inject(HttpClient)); }, token: ManifestService, providedIn: "root" });

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
class SystemInfoService {
    /**
     * @param {?} manifestService
     * @param {?} httpClient
     */
    constructor(manifestService, httpClient) {
        this.manifestService = manifestService;
        this.httpClient = httpClient;
        this._systemInfoLoaded = false;
    }
    /**
     * @return {?}
     */
    getSystemInfo() {
        return this._systemInfoLoaded ? of(this._systemInfo) :
            this.manifestService.getRootUrl().pipe(switchMap((rootUrl) => forkJoin(this.httpClient.get(`${rootUrl}api/system/info`), this.httpClient.get(`${rootUrl}api/systemSettings`)).pipe(map((res) => {
                return Object.assign({}, res[0], res[1]);
            }), tap((systemInfo) => {
                this._systemInfo = systemInfo;
                this._systemInfoLoaded = true;
            }))));
    }
    /**
     * @return {?}
     */
    getSystemVersion() {
        return this.getSystemInfo().pipe(map((systemInfo) => {
            if (!systemInfo) {
                return 0;
            }
            const /** @type {?} */ splitedVersion = systemInfo.version ? systemInfo.version.split('.') : [];
            return parseInt(splitedVersion[1], 10) || 0;
        }));
    }
}
SystemInfoService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] },
];
/** @nocollapse */
SystemInfoService.ctorParameters = () => [
    { type: ManifestService },
    { type: HttpClient }
];
/** @nocollapse */ SystemInfoService.ngInjectableDef = defineInjectable({ factory: function SystemInfoService_Factory() { return new SystemInfoService(inject(ManifestService), inject(HttpClient)); }, token: SystemInfoService, providedIn: "root" });

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
class NgxDhis2HttpClientService {
    /**
     * @param {?} httpClient
     * @param {?} manifestService
     * @param {?} systemInfoService
     */
    constructor(httpClient, manifestService, systemInfoService) {
        this.httpClient = httpClient;
        this.manifestService = manifestService;
        this.systemInfoService = systemInfoService;
    }
    /**
     * @param {?} url
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @return {?}
     */
    get(url, includeVersionNumber = false, preferPreviousApiVersion = false, useRootUrl = false) {
        const /** @type {?} */ rootUrlPromise = useRootUrl
            ? this.manifestService.getRootUrl()
            : this._getApiRootUrl(includeVersionNumber, preferPreviousApiVersion);
        return rootUrlPromise.pipe(mergeMap(rootUrl => this.httpClient.get(rootUrl + url).pipe(catchError(this._handleError))), catchError(this._handleError));
    }
    /**
     * @param {?} url
     * @param {?} data
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @param {?=} headerOptions
     * @return {?}
     */
    post(url, data, includeVersionNumber = false, preferPreviousApiVersion = false, useRootUrl = false, headerOptions) {
        const /** @type {?} */ rootUrlPromise = useRootUrl
            ? this.manifestService.getRootUrl()
            : this._getApiRootUrl(includeVersionNumber, preferPreviousApiVersion);
        return rootUrlPromise.pipe(mergeMap(rootUrl => this.httpClient
            .post(rootUrl + url, data)
            .pipe(catchError(this._handleError))), catchError(this._handleError));
    }
    /**
     * @param {?} url
     * @param {?} data
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @return {?}
     */
    put(url, data, includeVersionNumber = false, preferPreviousApiVersion = false, useRootUrl = false) {
        const /** @type {?} */ rootUrlPromise = useRootUrl
            ? this.manifestService.getRootUrl()
            : this._getApiRootUrl(includeVersionNumber, preferPreviousApiVersion);
        return rootUrlPromise.pipe(mergeMap(rootUrl => this.httpClient
            .put(rootUrl + url, data)
            .pipe(catchError(this._handleError))), catchError(this._handleError));
    }
    /**
     * @param {?} url
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @return {?}
     */
    delete(url, includeVersionNumber = false, preferPreviousApiVersion = false, useRootUrl = false) {
        const /** @type {?} */ rootUrlPromise = useRootUrl
            ? this.manifestService.getRootUrl()
            : this._getApiRootUrl(includeVersionNumber, preferPreviousApiVersion);
        return rootUrlPromise.pipe(mergeMap(rootUrl => this.httpClient
            .delete(rootUrl + url)
            .pipe(catchError(this._handleError))), catchError(this._handleError));
    }
    /**
     * @param {?} err
     * @return {?}
     */
    _handleError(err) {
        let /** @type {?} */ error = null;
        if (err.error instanceof ErrorEvent) {
            // A client-side or network error occurred. Handle it accordingly.
            error = {
                message: err.error,
                status: err.status,
                statusText: err.statusText
            };
        }
        else {
            // The backend returned an unsuccessful response code.
            // The response body may contain clues as to what went wrong,
            error = {
                message: err.error instanceof Object
                    ? err.error.message
                    : err.error || err.message,
                status: err.status,
                statusText: err.statusText
            };
        }
        return throwError(error);
    }
    /**
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousVersion
     * @return {?}
     */
    _getApiRootUrl(includeVersionNumber = false, preferPreviousVersion = false) {
        const /** @type {?} */ rootUrlPromise = this.manifestService.getRootUrl().pipe(switchMap(rootUrl => this.systemInfoService.getSystemVersion().pipe(map((version) => {
            return {
                rootUrl,
                version: version - 1 <= 25 ? version + 1 : version
            };
        }))));
        return rootUrlPromise.pipe(map((urlInfo) => `${urlInfo.rootUrl}api/${includeVersionNumber && !preferPreviousVersion
            ? urlInfo.version + '/'
            : preferPreviousVersion
                ? urlInfo.version
                    ? urlInfo.version - 1 + '/'
                    : ''
                : ''}`));
    }
}
NgxDhis2HttpClientService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] },
];
/** @nocollapse */
NgxDhis2HttpClientService.ctorParameters = () => [
    { type: HttpClient },
    { type: ManifestService },
    { type: SystemInfoService }
];
/** @nocollapse */ NgxDhis2HttpClientService.ngInjectableDef = defineInjectable({ factory: function NgxDhis2HttpClientService_Factory() { return new NgxDhis2HttpClientService(inject(HttpClient), inject(ManifestService), inject(SystemInfoService)); }, token: NgxDhis2HttpClientService, providedIn: "root" });

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
const /** @type {?} */ services = [ManifestService, SystemInfoService, NgxDhis2HttpClientService];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */

export { services, ManifestService, SystemInfoService, NgxDhis2HttpClientService };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlzcHR6LW5neC1kaGlzMi1odHRwLWNsaWVudC5qcy5tYXAiLCJzb3VyY2VzIjpbIm5nOi8vQGhpc3B0ei9uZ3gtZGhpczItaHR0cC1jbGllbnQvbGliL3NlcnZpY2VzL21hbmlmZXN0LnNlcnZpY2UudHMiLCJuZzovL0BoaXNwdHovbmd4LWRoaXMyLWh0dHAtY2xpZW50L2xpYi9zZXJ2aWNlcy9zeXN0ZW0taW5mby5zZXJ2aWNlLnRzIiwibmc6Ly9AaGlzcHR6L25neC1kaGlzMi1odHRwLWNsaWVudC9saWIvc2VydmljZXMvbmd4LWRoaXMyLWh0dHAtY2xpZW50LnNlcnZpY2UudHMiLCJuZzovL0BoaXNwdHovbmd4LWRoaXMyLWh0dHAtY2xpZW50L2xpYi9zZXJ2aWNlcy9pbmRleC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgTWFuaWZlc3QgfSBmcm9tICcuLi9tb2RlbHMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCwgY2F0Y2hFcnJvciwgbWFwIH0gZnJvbSAncnhqcy9pbnRlcm5hbC9vcGVyYXRvcnMnO1xuXG5ASW5qZWN0YWJsZSh7cHJvdmlkZWRJbjogJ3Jvb3QnfSlcbmV4cG9ydCBjbGFzcyBNYW5pZmVzdFNlcnZpY2Uge1xuICBwcml2YXRlIF9tYW5pZmVzdDogTWFuaWZlc3Q7XG4gIHByaXZhdGUgX2RlZmF1bHRSb290VXJsOiBzdHJpbmc7XG4gIHByaXZhdGUgX21hbmlmZXN0TG9hZGVkOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cENsaWVudDogSHR0cENsaWVudCkge1xuICAgIHRoaXMuX2RlZmF1bHRSb290VXJsID0gJy4uLy4uLy4uLyc7XG4gICAgdGhpcy5fbWFuaWZlc3RMb2FkZWQgPSBmYWxzZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRNYW5pZmVzdCgpOiBPYnNlcnZhYmxlPE1hbmlmZXN0PiB7XG4gICAgcmV0dXJuIHRoaXMuX21hbmlmZXN0TG9hZGVkID8gb2YodGhpcy5fbWFuaWZlc3QpIDogdGhpcy5odHRwQ2xpZW50LmdldDxNYW5pZmVzdD4oJ21hbmlmZXN0LndlYmFwcCcpLnBpcGUoXG4gICAgICBjYXRjaEVycm9yKCgpID0+IHtcbiAgICAgICAgY29uc29sZS53YXJuKCdNYW5pZmVzdCBmaWxlIGNvdWxkIG5vdCBiZSBsb2FkZWQsIGRlZmF1bHQgb3B0aW9ucyBoYXZlIGJlZW4gdXNlZCBpbnN0ZWFkJyk7XG4gICAgICAgIHJldHVybiBvZihudWxsKTtcbiAgICAgIH0pLFxuICAgICAgdGFwKChtYW5pZmVzdCkgPT4ge1xuICAgICAgICB0aGlzLl9tYW5pZmVzdCA9IG1hbmlmZXN0O1xuICAgICAgICB0aGlzLl9tYW5pZmVzdExvYWRlZCA9IHRydWU7XG4gICAgICB9KSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Um9vdFVybCgpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmdldE1hbmlmZXN0KCkucGlwZShtYXAoKG1hbmlmZXN0OiBNYW5pZmVzdCkgPT4ge1xuICAgICAgaWYgKCFtYW5pZmVzdCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZGVmYXVsdFJvb3RVcmw7XG4gICAgICB9XG4gICAgICByZXR1cm4gbWFuaWZlc3QuYWN0aXZpdGllcyAmJiBtYW5pZmVzdC5hY3Rpdml0aWVzLmRoaXMgJiYgbWFuaWZlc3QuYWN0aXZpdGllcy5kaGlzLmhyZWYgP1xuICAgICAgICBtYW5pZmVzdC5hY3Rpdml0aWVzLmRoaXMuaHJlZiA6IHRoaXMuX2RlZmF1bHRSb290VXJsO1xuICAgIH0pKTtcbiAgfVxufVxuIiwiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZm9ya0pvaW4sIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBNYW5pZmVzdFNlcnZpY2UgfSBmcm9tICcuL21hbmlmZXN0LnNlcnZpY2UnO1xuaW1wb3J0IHsgbWFwLCBzd2l0Y2hNYXAsIHRhcCB9IGZyb20gJ3J4anMvaW50ZXJuYWwvb3BlcmF0b3JzJztcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5cbkBJbmplY3RhYmxlKHtwcm92aWRlZEluOiAncm9vdCd9KVxuZXhwb3J0IGNsYXNzIFN5c3RlbUluZm9TZXJ2aWNlIHtcbiAgcHJpdmF0ZSBfc3lzdGVtSW5mb0xvYWRlZDogYm9vbGVhbjtcbiAgcHJpdmF0ZSBfc3lzdGVtSW5mbzogYW55O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbWFuaWZlc3RTZXJ2aWNlOiBNYW5pZmVzdFNlcnZpY2UsIHByaXZhdGUgaHR0cENsaWVudDogSHR0cENsaWVudCkge1xuICAgIHRoaXMuX3N5c3RlbUluZm9Mb2FkZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGdldFN5c3RlbUluZm8oKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5fc3lzdGVtSW5mb0xvYWRlZCA/IG9mKHRoaXMuX3N5c3RlbUluZm8pIDpcbiAgICAgIHRoaXMubWFuaWZlc3RTZXJ2aWNlLmdldFJvb3RVcmwoKS5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoKHJvb3RVcmw6IHN0cmluZykgPT4gZm9ya0pvaW4odGhpcy5odHRwQ2xpZW50LmdldChgJHtyb290VXJsfWFwaS9zeXN0ZW0vaW5mb2ApLFxuICAgICAgICAgIHRoaXMuaHR0cENsaWVudC5nZXQoYCR7cm9vdFVybH1hcGkvc3lzdGVtU2V0dGluZ3NgKSkucGlwZShtYXAoKHJlczogYW55W10pID0+IHtcbiAgICAgICAgICByZXR1cm4gey4uLnJlc1swXSwgLi4ucmVzWzFdfTtcbiAgICAgICAgfSksIHRhcCgoc3lzdGVtSW5mbzogYW55KSA9PiB7XG4gICAgICAgICAgdGhpcy5fc3lzdGVtSW5mbyA9IHN5c3RlbUluZm87XG4gICAgICAgICAgdGhpcy5fc3lzdGVtSW5mb0xvYWRlZCA9IHRydWU7XG4gICAgICAgIH0pKSkpO1xuICB9XG5cbiAgcHVibGljIGdldFN5c3RlbVZlcnNpb24oKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRTeXN0ZW1JbmZvKCkucGlwZShtYXAoKHN5c3RlbUluZm86IGFueSkgPT4ge1xuICAgICAgaWYgKCFzeXN0ZW1JbmZvKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfVxuICAgICAgY29uc3Qgc3BsaXRlZFZlcnNpb24gPSBzeXN0ZW1JbmZvLnZlcnNpb24gPyBzeXN0ZW1JbmZvLnZlcnNpb24uc3BsaXQoJy4nKSA6IFtdO1xuICAgICAgcmV0dXJuIHBhcnNlSW50KHNwbGl0ZWRWZXJzaW9uWzFdLCAxMCkgfHwgMDtcbiAgICB9KSk7XG4gIH1cbn1cbiIsImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBFcnJvclJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgTWFuaWZlc3RTZXJ2aWNlIH0gZnJvbSAnLi9tYW5pZmVzdC5zZXJ2aWNlJztcbmltcG9ydCB7IFN5c3RlbUluZm9TZXJ2aWNlIH0gZnJvbSAnLi9zeXN0ZW0taW5mby5zZXJ2aWNlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIG1hcCwgbWVyZ2VNYXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvaW50ZXJuYWwvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBOZ3hEaGlzMkh0dHBDbGllbnRTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LFxuICAgIHByaXZhdGUgbWFuaWZlc3RTZXJ2aWNlOiBNYW5pZmVzdFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBzeXN0ZW1JbmZvU2VydmljZTogU3lzdGVtSW5mb1NlcnZpY2VcbiAgKSB7fVxuXG4gIGdldChcbiAgICB1cmw6IHN0cmluZyxcbiAgICBpbmNsdWRlVmVyc2lvbk51bWJlcjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHByZWZlclByZXZpb3VzQXBpVmVyc2lvbjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHVzZVJvb3RVcmw6IGJvb2xlYW4gPSBmYWxzZVxuICApOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHJvb3RVcmxQcm9taXNlID0gdXNlUm9vdFVybFxuICAgICAgPyB0aGlzLm1hbmlmZXN0U2VydmljZS5nZXRSb290VXJsKClcbiAgICAgIDogdGhpcy5fZ2V0QXBpUm9vdFVybChpbmNsdWRlVmVyc2lvbk51bWJlciwgcHJlZmVyUHJldmlvdXNBcGlWZXJzaW9uKTtcblxuICAgIHJldHVybiByb290VXJsUHJvbWlzZS5waXBlKFxuICAgICAgbWVyZ2VNYXAocm9vdFVybCA9PlxuICAgICAgICB0aGlzLmh0dHBDbGllbnQuZ2V0KHJvb3RVcmwgKyB1cmwpLnBpcGUoY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcikpXG4gICAgICApLFxuICAgICAgY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcilcbiAgICApO1xuICB9XG5cbiAgcG9zdChcbiAgICB1cmw6IHN0cmluZyxcbiAgICBkYXRhOiBhbnksXG4gICAgaW5jbHVkZVZlcnNpb25OdW1iZXI6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBwcmVmZXJQcmV2aW91c0FwaVZlcnNpb246IGJvb2xlYW4gPSBmYWxzZSxcbiAgICB1c2VSb290VXJsOiBib29sZWFuID0gZmFsc2UsXG4gICAgaGVhZGVyT3B0aW9ucz86IGFueVxuICApIHtcbiAgICBjb25zdCByb290VXJsUHJvbWlzZSA9IHVzZVJvb3RVcmxcbiAgICAgID8gdGhpcy5tYW5pZmVzdFNlcnZpY2UuZ2V0Um9vdFVybCgpXG4gICAgICA6IHRoaXMuX2dldEFwaVJvb3RVcmwoaW5jbHVkZVZlcnNpb25OdW1iZXIsIHByZWZlclByZXZpb3VzQXBpVmVyc2lvbik7XG4gICAgcmV0dXJuIHJvb3RVcmxQcm9taXNlLnBpcGUoXG4gICAgICBtZXJnZU1hcChyb290VXJsID0+XG4gICAgICAgIHRoaXMuaHR0cENsaWVudFxuICAgICAgICAgIC5wb3N0KHJvb3RVcmwgKyB1cmwsIGRhdGEpXG4gICAgICAgICAgLnBpcGUoY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcikpXG4gICAgICApLFxuICAgICAgY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcilcbiAgICApO1xuICB9XG5cbiAgcHV0KFxuICAgIHVybDogc3RyaW5nLFxuICAgIGRhdGE6IGFueSxcbiAgICBpbmNsdWRlVmVyc2lvbk51bWJlcjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHByZWZlclByZXZpb3VzQXBpVmVyc2lvbjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHVzZVJvb3RVcmw6IGJvb2xlYW4gPSBmYWxzZVxuICApIHtcbiAgICBjb25zdCByb290VXJsUHJvbWlzZSA9IHVzZVJvb3RVcmxcbiAgICAgID8gdGhpcy5tYW5pZmVzdFNlcnZpY2UuZ2V0Um9vdFVybCgpXG4gICAgICA6IHRoaXMuX2dldEFwaVJvb3RVcmwoaW5jbHVkZVZlcnNpb25OdW1iZXIsIHByZWZlclByZXZpb3VzQXBpVmVyc2lvbik7XG5cbiAgICByZXR1cm4gcm9vdFVybFByb21pc2UucGlwZShcbiAgICAgIG1lcmdlTWFwKHJvb3RVcmwgPT5cbiAgICAgICAgdGhpcy5odHRwQ2xpZW50XG4gICAgICAgICAgLnB1dChyb290VXJsICsgdXJsLCBkYXRhKVxuICAgICAgICAgIC5waXBlKGNhdGNoRXJyb3IodGhpcy5faGFuZGxlRXJyb3IpKVxuICAgICAgKSxcbiAgICAgIGNhdGNoRXJyb3IodGhpcy5faGFuZGxlRXJyb3IpXG4gICAgKTtcbiAgfVxuXG4gIGRlbGV0ZShcbiAgICB1cmw6IHN0cmluZyxcbiAgICBpbmNsdWRlVmVyc2lvbk51bWJlcjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHByZWZlclByZXZpb3VzQXBpVmVyc2lvbjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHVzZVJvb3RVcmw6IGJvb2xlYW4gPSBmYWxzZVxuICApIHtcbiAgICBjb25zdCByb290VXJsUHJvbWlzZSA9IHVzZVJvb3RVcmxcbiAgICAgID8gdGhpcy5tYW5pZmVzdFNlcnZpY2UuZ2V0Um9vdFVybCgpXG4gICAgICA6IHRoaXMuX2dldEFwaVJvb3RVcmwoaW5jbHVkZVZlcnNpb25OdW1iZXIsIHByZWZlclByZXZpb3VzQXBpVmVyc2lvbik7XG5cbiAgICByZXR1cm4gcm9vdFVybFByb21pc2UucGlwZShcbiAgICAgIG1lcmdlTWFwKHJvb3RVcmwgPT5cbiAgICAgICAgdGhpcy5odHRwQ2xpZW50XG4gICAgICAgICAgLmRlbGV0ZShyb290VXJsICsgdXJsKVxuICAgICAgICAgIC5waXBlKGNhdGNoRXJyb3IodGhpcy5faGFuZGxlRXJyb3IpKVxuICAgICAgKSxcbiAgICAgIGNhdGNoRXJyb3IodGhpcy5faGFuZGxlRXJyb3IpXG4gICAgKTtcbiAgfVxuXG4gIC8vIHByaXZhdGUgbWV0aG9kc1xuICBwcml2YXRlIF9oYW5kbGVFcnJvcihlcnI6IEh0dHBFcnJvclJlc3BvbnNlKSB7XG4gICAgbGV0IGVycm9yID0gbnVsbDtcbiAgICBpZiAoZXJyLmVycm9yIGluc3RhbmNlb2YgRXJyb3JFdmVudCkge1xuICAgICAgLy8gQSBjbGllbnQtc2lkZSBvciBuZXR3b3JrIGVycm9yIG9jY3VycmVkLiBIYW5kbGUgaXQgYWNjb3JkaW5nbHkuXG4gICAgICBlcnJvciA9IHtcbiAgICAgICAgbWVzc2FnZTogZXJyLmVycm9yLFxuICAgICAgICBzdGF0dXM6IGVyci5zdGF0dXMsXG4gICAgICAgIHN0YXR1c1RleHQ6IGVyci5zdGF0dXNUZXh0XG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBUaGUgYmFja2VuZCByZXR1cm5lZCBhbiB1bnN1Y2Nlc3NmdWwgcmVzcG9uc2UgY29kZS5cbiAgICAgIC8vIFRoZSByZXNwb25zZSBib2R5IG1heSBjb250YWluIGNsdWVzIGFzIHRvIHdoYXQgd2VudCB3cm9uZyxcbiAgICAgIGVycm9yID0ge1xuICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgIGVyci5lcnJvciBpbnN0YW5jZW9mIE9iamVjdFxuICAgICAgICAgICAgPyBlcnIuZXJyb3IubWVzc2FnZVxuICAgICAgICAgICAgOiBlcnIuZXJyb3IgfHwgZXJyLm1lc3NhZ2UsXG4gICAgICAgIHN0YXR1czogZXJyLnN0YXR1cyxcbiAgICAgICAgc3RhdHVzVGV4dDogZXJyLnN0YXR1c1RleHRcbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yKTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldEFwaVJvb3RVcmwoXG4gICAgaW5jbHVkZVZlcnNpb25OdW1iZXI6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBwcmVmZXJQcmV2aW91c1ZlcnNpb246IGJvb2xlYW4gPSBmYWxzZVxuICApIHtcbiAgICBjb25zdCByb290VXJsUHJvbWlzZSA9IHRoaXMubWFuaWZlc3RTZXJ2aWNlLmdldFJvb3RVcmwoKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKHJvb3RVcmwgPT5cbiAgICAgICAgdGhpcy5zeXN0ZW1JbmZvU2VydmljZS5nZXRTeXN0ZW1WZXJzaW9uKCkucGlwZShcbiAgICAgICAgICBtYXAoKHZlcnNpb246IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgcm9vdFVybCxcbiAgICAgICAgICAgICAgdmVyc2lvbjogdmVyc2lvbiAtIDEgPD0gMjUgPyB2ZXJzaW9uICsgMSA6IHZlcnNpb25cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICk7XG4gICAgcmV0dXJuIHJvb3RVcmxQcm9taXNlLnBpcGUoXG4gICAgICBtYXAoXG4gICAgICAgICh1cmxJbmZvOiB7IHJvb3RVcmw6IHN0cmluZzsgdmVyc2lvbjogbnVtYmVyIH0pID0+XG4gICAgICAgICAgYCR7dXJsSW5mby5yb290VXJsfWFwaS8ke1xuICAgICAgICAgICAgaW5jbHVkZVZlcnNpb25OdW1iZXIgJiYgIXByZWZlclByZXZpb3VzVmVyc2lvblxuICAgICAgICAgICAgICA/IHVybEluZm8udmVyc2lvbiArICcvJ1xuICAgICAgICAgICAgICA6IHByZWZlclByZXZpb3VzVmVyc2lvblxuICAgICAgICAgICAgICAgID8gdXJsSW5mby52ZXJzaW9uXG4gICAgICAgICAgICAgICAgICA/IHVybEluZm8udmVyc2lvbiAtIDEgKyAnLydcbiAgICAgICAgICAgICAgICAgIDogJydcbiAgICAgICAgICAgICAgICA6ICcnXG4gICAgICAgICAgfWBcbiAgICAgIClcbiAgICApO1xuICB9XG59XG4iLCJpbXBvcnQgeyBNYW5pZmVzdFNlcnZpY2UgfSBmcm9tICcuL21hbmlmZXN0LnNlcnZpY2UnO1xuaW1wb3J0IHsgU3lzdGVtSW5mb1NlcnZpY2UgfSBmcm9tICcuL3N5c3RlbS1pbmZvLnNlcnZpY2UnO1xuaW1wb3J0IHsgTmd4RGhpczJIdHRwQ2xpZW50U2VydmljZSB9IGZyb20gJy4vbmd4LWRoaXMyLWh0dHAtY2xpZW50LnNlcnZpY2UnO1xuXG5leHBvcnQgY29uc3Qgc2VydmljZXM6IGFueVtdID0gW01hbmlmZXN0U2VydmljZSwgU3lzdGVtSW5mb1NlcnZpY2UsIE5neERoaXMySHR0cENsaWVudFNlcnZpY2VdO1xuXG5leHBvcnQgKiBmcm9tICcuL21hbmlmZXN0LnNlcnZpY2UnO1xuZXhwb3J0ICogZnJvbSAnLi9zeXN0ZW0taW5mby5zZXJ2aWNlJztcbmV4cG9ydCAqIGZyb20gJy4vbmd4LWRoaXMyLWh0dHAtY2xpZW50LnNlcnZpY2UnO1xuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOzs7O0lBWUUsWUFBb0IsVUFBc0I7UUFBdEIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN4QyxJQUFJLENBQUMsZUFBZSxHQUFHLFdBQVcsQ0FBQztRQUNuQyxJQUFJLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQztLQUM5Qjs7OztJQUVNLFdBQVc7UUFDaEIsT0FBTyxJQUFJLENBQUMsZUFBZSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQVcsaUJBQWlCLENBQUMsQ0FBQyxJQUFJLENBQ3RHLFVBQVUsQ0FBQztZQUNULE9BQU8sQ0FBQyxJQUFJLENBQUMsMkVBQTJFLENBQUMsQ0FBQztZQUMxRixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQixDQUFDLEVBQ0YsR0FBRyxDQUFDLENBQUMsUUFBUTtZQUNYLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1lBQzFCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1NBQzdCLENBQUMsQ0FBQyxDQUFDOzs7OztJQUdELFVBQVU7UUFDZixPQUFPLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBa0I7WUFDcEQsSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDYixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUM7YUFDN0I7WUFDRCxPQUFPLFFBQVEsQ0FBQyxVQUFVLElBQUksUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLElBQUksUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSTtnQkFDckYsUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUM7U0FDeEQsQ0FBQyxDQUFDLENBQUM7Ozs7WUE5QlAsVUFBVSxTQUFDLEVBQUMsVUFBVSxFQUFFLE1BQU0sRUFBQzs7OztZQUx2QixVQUFVOzs7Ozs7OztBQ0RuQjs7Ozs7SUFXRSxZQUFvQixlQUFnQyxFQUFVLFVBQXNCO1FBQWhFLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUFVLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDbEYsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEtBQUssQ0FBQztLQUNoQzs7OztJQUVELGFBQWE7UUFDWCxPQUFPLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQztZQUNsRCxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRSxDQUFDLElBQUksQ0FDcEMsU0FBUyxDQUFDLENBQUMsT0FBZSxLQUFLLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE9BQU8saUJBQWlCLENBQUMsRUFDdEYsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxPQUFPLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBVTtnQkFDekUseUJBQVcsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRTthQUMvQixDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsVUFBZTtnQkFDdEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxVQUFVLENBQUM7Z0JBQzlCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7YUFDL0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ1g7Ozs7SUFFTSxnQkFBZ0I7UUFDckIsT0FBTyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFVBQWU7WUFDbkQsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDZixPQUFPLENBQUMsQ0FBQzthQUNWO1lBQ0QsdUJBQU0sY0FBYyxHQUFHLFVBQVUsQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQy9FLE9BQU8sUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDN0MsQ0FBQyxDQUFDLENBQUM7Ozs7WUE1QlAsVUFBVSxTQUFDLEVBQUMsVUFBVSxFQUFFLE1BQU0sRUFBQzs7OztZQUp2QixlQUFlO1lBRWYsVUFBVTs7Ozs7Ozs7QUNKbkI7Ozs7OztJQVNFLFlBQ1UsWUFDQSxpQkFDQTtRQUZBLGVBQVUsR0FBVixVQUFVO1FBQ1Ysb0JBQWUsR0FBZixlQUFlO1FBQ2Ysc0JBQWlCLEdBQWpCLGlCQUFpQjtLQUN2Qjs7Ozs7Ozs7SUFFSixHQUFHLENBQ0QsR0FBVyxFQUNYLHVCQUFnQyxLQUFLLEVBQ3JDLDJCQUFvQyxLQUFLLEVBQ3pDLGFBQXNCLEtBQUs7UUFFM0IsdUJBQU0sY0FBYyxHQUFHLFVBQVU7Y0FDN0IsSUFBSSxDQUFDLGVBQWUsQ0FBQyxVQUFVLEVBQUU7Y0FDakMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxvQkFBb0IsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO1FBRXhFLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FDeEIsUUFBUSxDQUFDLE9BQU8sSUFDZCxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FDdkUsRUFDRCxVQUFVLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUM5QixDQUFDO0tBQ0g7Ozs7Ozs7Ozs7SUFFRCxJQUFJLENBQ0YsR0FBVyxFQUNYLElBQVMsRUFDVCx1QkFBZ0MsS0FBSyxFQUNyQywyQkFBb0MsS0FBSyxFQUN6QyxhQUFzQixLQUFLLEVBQzNCLGFBQW1CO1FBRW5CLHVCQUFNLGNBQWMsR0FBRyxVQUFVO2NBQzdCLElBQUksQ0FBQyxlQUFlLENBQUMsVUFBVSxFQUFFO2NBQ2pDLElBQUksQ0FBQyxjQUFjLENBQUMsb0JBQW9CLEVBQUUsd0JBQXdCLENBQUMsQ0FBQztRQUN4RSxPQUFPLGNBQWMsQ0FBQyxJQUFJLENBQ3hCLFFBQVEsQ0FBQyxPQUFPLElBQ2QsSUFBSSxDQUFDLFVBQVU7YUFDWixJQUFJLENBQUMsT0FBTyxHQUFHLEdBQUcsRUFBRSxJQUFJLENBQUM7YUFDekIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FDdkMsRUFDRCxVQUFVLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUM5QixDQUFDO0tBQ0g7Ozs7Ozs7OztJQUVELEdBQUcsQ0FDRCxHQUFXLEVBQ1gsSUFBUyxFQUNULHVCQUFnQyxLQUFLLEVBQ3JDLDJCQUFvQyxLQUFLLEVBQ3pDLGFBQXNCLEtBQUs7UUFFM0IsdUJBQU0sY0FBYyxHQUFHLFVBQVU7Y0FDN0IsSUFBSSxDQUFDLGVBQWUsQ0FBQyxVQUFVLEVBQUU7Y0FDakMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxvQkFBb0IsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO1FBRXhFLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FDeEIsUUFBUSxDQUFDLE9BQU8sSUFDZCxJQUFJLENBQUMsVUFBVTthQUNaLEdBQUcsQ0FBQyxPQUFPLEdBQUcsR0FBRyxFQUFFLElBQUksQ0FBQzthQUN4QixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUN2QyxFQUNELFVBQVUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQzlCLENBQUM7S0FDSDs7Ozs7Ozs7SUFFRCxNQUFNLENBQ0osR0FBVyxFQUNYLHVCQUFnQyxLQUFLLEVBQ3JDLDJCQUFvQyxLQUFLLEVBQ3pDLGFBQXNCLEtBQUs7UUFFM0IsdUJBQU0sY0FBYyxHQUFHLFVBQVU7Y0FDN0IsSUFBSSxDQUFDLGVBQWUsQ0FBQyxVQUFVLEVBQUU7Y0FDakMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxvQkFBb0IsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO1FBRXhFLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FDeEIsUUFBUSxDQUFDLE9BQU8sSUFDZCxJQUFJLENBQUMsVUFBVTthQUNaLE1BQU0sQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDO2FBQ3JCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQ3ZDLEVBQ0QsVUFBVSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FDOUIsQ0FBQztLQUNIOzs7OztJQUdPLFlBQVksQ0FBQyxHQUFzQjtRQUN6QyxxQkFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksR0FBRyxDQUFDLEtBQUssWUFBWSxVQUFVLEVBQUU7O1lBRW5DLEtBQUssR0FBRztnQkFDTixPQUFPLEVBQUUsR0FBRyxDQUFDLEtBQUs7Z0JBQ2xCLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTTtnQkFDbEIsVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVO2FBQzNCLENBQUM7U0FDSDthQUFNOzs7WUFHTCxLQUFLLEdBQUc7Z0JBQ04sT0FBTyxFQUNMLEdBQUcsQ0FBQyxLQUFLLFlBQVksTUFBTTtzQkFDdkIsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPO3NCQUNqQixHQUFHLENBQUMsS0FBSyxJQUFJLEdBQUcsQ0FBQyxPQUFPO2dCQUM5QixNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU07Z0JBQ2xCLFVBQVUsRUFBRSxHQUFHLENBQUMsVUFBVTthQUMzQixDQUFDO1NBQ0g7UUFDRCxPQUFPLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQzs7Ozs7OztJQUduQixjQUFjLENBQ3BCLHVCQUFnQyxLQUFLLEVBQ3JDLHdCQUFpQyxLQUFLO1FBRXRDLHVCQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRSxDQUFDLElBQUksQ0FDM0QsU0FBUyxDQUFDLE9BQU8sSUFDZixJQUFJLENBQUMsaUJBQWlCLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxJQUFJLENBQzVDLEdBQUcsQ0FBQyxDQUFDLE9BQWU7WUFDbEIsT0FBTztnQkFDTCxPQUFPO2dCQUNQLE9BQU8sRUFBRSxPQUFPLEdBQUcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxPQUFPLEdBQUcsQ0FBQyxHQUFHLE9BQU87YUFDbkQsQ0FBQztTQUNILENBQUMsQ0FDSCxDQUNGLENBQ0YsQ0FBQztRQUNGLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FDeEIsR0FBRyxDQUNELENBQUMsT0FBNkMsS0FDNUMsR0FBRyxPQUFPLENBQUMsT0FBTyxPQUNoQixvQkFBb0IsSUFBSSxDQUFDLHFCQUFxQjtjQUMxQyxPQUFPLENBQUMsT0FBTyxHQUFHLEdBQUc7Y0FDckIscUJBQXFCO2tCQUNuQixPQUFPLENBQUMsT0FBTztzQkFDYixPQUFPLENBQUMsT0FBTyxHQUFHLENBQUMsR0FBRyxHQUFHO3NCQUN6QixFQUFFO2tCQUNKLEVBQ1IsRUFBRSxDQUNMLENBQ0YsQ0FBQzs7OztZQTlJTCxVQUFVLFNBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFOzs7O1lBTnpCLFVBQVU7WUFDVixlQUFlO1lBQ2YsaUJBQWlCOzs7Ozs7OztBQ0gxQix1QkFJYSxRQUFRLEdBQVUsQ0FBQyxlQUFlLEVBQUUsaUJBQWlCLEVBQUUseUJBQXlCLENBQUM7Ozs7Ozs7Ozs7Ozs7OyJ9