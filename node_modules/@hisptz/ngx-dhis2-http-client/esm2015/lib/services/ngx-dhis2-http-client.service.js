/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { ManifestService } from './manifest.service';
import { SystemInfoService } from './system-info.service';
import { throwError } from 'rxjs';
import { catchError, map, mergeMap, switchMap } from 'rxjs/internal/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./manifest.service";
import * as i3 from "./system-info.service";
export class NgxDhis2HttpClientService {
    /**
     * @param {?} httpClient
     * @param {?} manifestService
     * @param {?} systemInfoService
     */
    constructor(httpClient, manifestService, systemInfoService) {
        this.httpClient = httpClient;
        this.manifestService = manifestService;
        this.systemInfoService = systemInfoService;
    }
    /**
     * @param {?} url
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @return {?}
     */
    get(url, includeVersionNumber = false, preferPreviousApiVersion = false, useRootUrl = false) {
        const /** @type {?} */ rootUrlPromise = useRootUrl
            ? this.manifestService.getRootUrl()
            : this._getApiRootUrl(includeVersionNumber, preferPreviousApiVersion);
        return rootUrlPromise.pipe(mergeMap(rootUrl => this.httpClient.get(rootUrl + url).pipe(catchError(this._handleError))), catchError(this._handleError));
    }
    /**
     * @param {?} url
     * @param {?} data
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @param {?=} headerOptions
     * @return {?}
     */
    post(url, data, includeVersionNumber = false, preferPreviousApiVersion = false, useRootUrl = false, headerOptions) {
        const /** @type {?} */ rootUrlPromise = useRootUrl
            ? this.manifestService.getRootUrl()
            : this._getApiRootUrl(includeVersionNumber, preferPreviousApiVersion);
        return rootUrlPromise.pipe(mergeMap(rootUrl => this.httpClient
            .post(rootUrl + url, data)
            .pipe(catchError(this._handleError))), catchError(this._handleError));
    }
    /**
     * @param {?} url
     * @param {?} data
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @return {?}
     */
    put(url, data, includeVersionNumber = false, preferPreviousApiVersion = false, useRootUrl = false) {
        const /** @type {?} */ rootUrlPromise = useRootUrl
            ? this.manifestService.getRootUrl()
            : this._getApiRootUrl(includeVersionNumber, preferPreviousApiVersion);
        return rootUrlPromise.pipe(mergeMap(rootUrl => this.httpClient
            .put(rootUrl + url, data)
            .pipe(catchError(this._handleError))), catchError(this._handleError));
    }
    /**
     * @param {?} url
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @return {?}
     */
    delete(url, includeVersionNumber = false, preferPreviousApiVersion = false, useRootUrl = false) {
        const /** @type {?} */ rootUrlPromise = useRootUrl
            ? this.manifestService.getRootUrl()
            : this._getApiRootUrl(includeVersionNumber, preferPreviousApiVersion);
        return rootUrlPromise.pipe(mergeMap(rootUrl => this.httpClient
            .delete(rootUrl + url)
            .pipe(catchError(this._handleError))), catchError(this._handleError));
    }
    /**
     * @param {?} err
     * @return {?}
     */
    _handleError(err) {
        let /** @type {?} */ error = null;
        if (err.error instanceof ErrorEvent) {
            // A client-side or network error occurred. Handle it accordingly.
            error = {
                message: err.error,
                status: err.status,
                statusText: err.statusText
            };
        }
        else {
            // The backend returned an unsuccessful response code.
            // The response body may contain clues as to what went wrong,
            error = {
                message: err.error instanceof Object
                    ? err.error.message
                    : err.error || err.message,
                status: err.status,
                statusText: err.statusText
            };
        }
        return throwError(error);
    }
    /**
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousVersion
     * @return {?}
     */
    _getApiRootUrl(includeVersionNumber = false, preferPreviousVersion = false) {
        const /** @type {?} */ rootUrlPromise = this.manifestService.getRootUrl().pipe(switchMap(rootUrl => this.systemInfoService.getSystemVersion().pipe(map((version) => {
            return {
                rootUrl,
                version: version - 1 <= 25 ? version + 1 : version
            };
        }))));
        return rootUrlPromise.pipe(map((urlInfo) => `${urlInfo.rootUrl}api/${includeVersionNumber && !preferPreviousVersion
            ? urlInfo.version + '/'
            : preferPreviousVersion
                ? urlInfo.version
                    ? urlInfo.version - 1 + '/'
                    : ''
                : ''}`));
    }
}
NgxDhis2HttpClientService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] },
];
/** @nocollapse */
NgxDhis2HttpClientService.ctorParameters = () => [
    { type: HttpClient },
    { type: ManifestService },
    { type: SystemInfoService }
];
/** @nocollapse */ NgxDhis2HttpClientService.ngInjectableDef = i0.defineInjectable({ factory: function NgxDhis2HttpClientService_Factory() { return new NgxDhis2HttpClientService(i0.inject(i1.HttpClient), i0.inject(i2.ManifestService), i0.inject(i3.SystemInfoService)); }, token: NgxDhis2HttpClientService, providedIn: "root" });
function NgxDhis2HttpClientService_tsickle_Closure_declarations() {
    /** @type {?} */
    NgxDhis2HttpClientService.prototype.httpClient;
    /** @type {?} */
    NgxDhis2HttpClientService.prototype.manifestService;
    /** @type {?} */
    NgxDhis2HttpClientService.prototype.systemInfoService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWRoaXMyLWh0dHAtY2xpZW50LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AaGlzcHR6L25neC1kaGlzMi1odHRwLWNsaWVudC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9uZ3gtZGhpczItaHR0cC1jbGllbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFxQixNQUFNLHNCQUFzQixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQWMsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQzs7Ozs7QUFHL0UsTUFBTTs7Ozs7O0lBQ0osWUFDVSxZQUNBLGlCQUNBO1FBRkEsZUFBVSxHQUFWLFVBQVU7UUFDVixvQkFBZSxHQUFmLGVBQWU7UUFDZixzQkFBaUIsR0FBakIsaUJBQWlCO0tBQ3ZCOzs7Ozs7OztJQUVKLEdBQUcsQ0FDRCxHQUFXLEVBQ1gsdUJBQWdDLEtBQUssRUFDckMsMkJBQW9DLEtBQUssRUFDekMsYUFBc0IsS0FBSztRQUUzQix1QkFBTSxjQUFjLEdBQUcsVUFBVTtZQUMvQixDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxVQUFVLEVBQUU7WUFDbkMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsb0JBQW9CLEVBQUUsd0JBQXdCLENBQUMsQ0FBQztRQUV4RSxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FDeEIsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQ2pCLElBQUksQ0FBQyxVQUFVLENBQUMsR0FB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RyxDQUFDLEdBQUcsR0FBRztvQkFDM0IsQ0FBQyxDQUFDLEVBQUU7Z0JBQ04sQ0FBQyxDQUFDLEVBQ1IsRUFBRSxDQUNMLENBQ0YsQ0FBQzs7OztZQTlJTCxVQUFVLFNBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFOzs7O1lBTnpCLFVBQVU7WUFDVixlQUFlO1lBQ2YsaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEVycm9yUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBNYW5pZmVzdFNlcnZpY2UgfSBmcm9tICcuL21hbmlmZXN0LnNlcnZpY2UnO1xuaW1wb3J0IHsgU3lzdGVtSW5mb1NlcnZpY2UgfSBmcm9tICcuL3N5c3RlbS1pbmZvLnNlcnZpY2UnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBtZXJnZU1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9pbnRlcm5hbC9vcGVyYXRvcnMnO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIE5neERoaXMySHR0cENsaWVudFNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQsXG4gICAgcHJpdmF0ZSBtYW5pZmVzdFNlcnZpY2U6IE1hbmlmZXN0U2VydmljZSxcbiAgICBwcml2YXRlIHN5c3RlbUluZm9TZXJ2aWNlOiBTeXN0ZW1JbmZvU2VydmljZVxuICApIHt9XG5cbiAgZ2V0KFxuICAgIHVybDogc3RyaW5nLFxuICAgIGluY2x1ZGVWZXJzaW9uTnVtYmVyOiBib29sZWFuID0gZmFsc2UsXG4gICAgcHJlZmVyUHJldmlvdXNBcGlWZXJzaW9uOiBib29sZWFuID0gZmFsc2UsXG4gICAgdXNlUm9vdFVybDogYm9vbGVhbiA9IGZhbHNlXG4gICk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3Qgcm9vdFVybFByb21pc2UgPSB1c2VSb290VXJsXG4gICAgICA/IHRoaXMubWFuaWZlc3RTZXJ2aWNlLmdldFJvb3RVcmwoKVxuICAgICAgOiB0aGlzLl9nZXRBcGlSb290VXJsKGluY2x1ZGVWZXJzaW9uTnVtYmVyLCBwcmVmZXJQcmV2aW91c0FwaVZlcnNpb24pO1xuXG4gICAgcmV0dXJuIHJvb3RVcmxQcm9taXNlLnBpcGUoXG4gICAgICBtZXJnZU1hcChyb290VXJsID0+XG4gICAgICAgIHRoaXMuaHR0cENsaWVudC5nZXQocm9vdFVybCArIHVybCkucGlwZShjYXRjaEVycm9yKHRoaXMuX2hhbmRsZUVycm9yKSlcbiAgICAgICksXG4gICAgICBjYXRjaEVycm9yKHRoaXMuX2hhbmRsZUVycm9yKVxuICAgICk7XG4gIH1cblxuICBwb3N0KFxuICAgIHVybDogc3RyaW5nLFxuICAgIGRhdGE6IGFueSxcbiAgICBpbmNsdWRlVmVyc2lvbk51bWJlcjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHByZWZlclByZXZpb3VzQXBpVmVyc2lvbjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHVzZVJvb3RVcmw6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBoZWFkZXJPcHRpb25zPzogYW55XG4gICkge1xuICAgIGNvbnN0IHJvb3RVcmxQcm9taXNlID0gdXNlUm9vdFVybFxuICAgICAgPyB0aGlzLm1hbmlmZXN0U2VydmljZS5nZXRSb290VXJsKClcbiAgICAgIDogdGhpcy5fZ2V0QXBpUm9vdFVybChpbmNsdWRlVmVyc2lvbk51bWJlciwgcHJlZmVyUHJldmlvdXNBcGlWZXJzaW9uKTtcbiAgICByZXR1cm4gcm9vdFVybFByb21pc2UucGlwZShcbiAgICAgIG1lcmdlTWFwKHJvb3RVcmwgPT5cbiAgICAgICAgdGhpcy5odHRwQ2xpZW50XG4gICAgICAgICAgLnBvc3Qocm9vdFVybCArIHVybCwgZGF0YSlcbiAgICAgICAgICAucGlwZShjYXRjaEVycm9yKHRoaXMuX2hhbmRsZUVycm9yKSlcbiAgICAgICksXG4gICAgICBjYXRjaEVycm9yKHRoaXMuX2hhbmRsZUVycm9yKVxuICAgICk7XG4gIH1cblxuICBwdXQoXG4gICAgdXJsOiBzdHJpbmcsXG4gICAgZGF0YTogYW55LFxuICAgIGluY2x1ZGVWZXJzaW9uTnVtYmVyOiBib29sZWFuID0gZmFsc2UsXG4gICAgcHJlZmVyUHJldmlvdXNBcGlWZXJzaW9uOiBib29sZWFuID0gZmFsc2UsXG4gICAgdXNlUm9vdFVybDogYm9vbGVhbiA9IGZhbHNlXG4gICkge1xuICAgIGNvbnN0IHJvb3RVcmxQcm9taXNlID0gdXNlUm9vdFVybFxuICAgICAgPyB0aGlzLm1hbmlmZXN0U2VydmljZS5nZXRSb290VXJsKClcbiAgICAgIDogdGhpcy5fZ2V0QXBpUm9vdFVybChpbmNsdWRlVmVyc2lvbk51bWJlciwgcHJlZmVyUHJldmlvdXNBcGlWZXJzaW9uKTtcblxuICAgIHJldHVybiByb290VXJsUHJvbWlzZS5waXBlKFxuICAgICAgbWVyZ2VNYXAocm9vdFVybCA9PlxuICAgICAgICB0aGlzLmh0dHBDbGllbnRcbiAgICAgICAgICAucHV0KHJvb3RVcmwgKyB1cmwsIGRhdGEpXG4gICAgICAgICAgLnBpcGUoY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcikpXG4gICAgICApLFxuICAgICAgY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcilcbiAgICApO1xuICB9XG5cbiAgZGVsZXRlKFxuICAgIHVybDogc3RyaW5nLFxuICAgIGluY2x1ZGVWZXJzaW9uTnVtYmVyOiBib29sZWFuID0gZmFsc2UsXG4gICAgcHJlZmVyUHJldmlvdXNBcGlWZXJzaW9uOiBib29sZWFuID0gZmFsc2UsXG4gICAgdXNlUm9vdFVybDogYm9vbGVhbiA9IGZhbHNlXG4gICkge1xuICAgIGNvbnN0IHJvb3RVcmxQcm9taXNlID0gdXNlUm9vdFVybFxuICAgICAgPyB0aGlzLm1hbmlmZXN0U2VydmljZS5nZXRSb290VXJsKClcbiAgICAgIDogdGhpcy5fZ2V0QXBpUm9vdFVybChpbmNsdWRlVmVyc2lvbk51bWJlciwgcHJlZmVyUHJldmlvdXNBcGlWZXJzaW9uKTtcblxuICAgIHJldHVybiByb290VXJsUHJvbWlzZS5waXBlKFxuICAgICAgbWVyZ2VNYXAocm9vdFVybCA9PlxuICAgICAgICB0aGlzLmh0dHBDbGllbnRcbiAgICAgICAgICAuZGVsZXRlKHJvb3RVcmwgKyB1cmwpXG4gICAgICAgICAgLnBpcGUoY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcikpXG4gICAgICApLFxuICAgICAgY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcilcbiAgICApO1xuICB9XG5cbiAgLy8gcHJpdmF0ZSBtZXRob2RzXG4gIHByaXZhdGUgX2hhbmRsZUVycm9yKGVycjogSHR0cEVycm9yUmVzcG9uc2UpIHtcbiAgICBsZXQgZXJyb3IgPSBudWxsO1xuICAgIGlmIChlcnIuZXJyb3IgaW5zdGFuY2VvZiBFcnJvckV2ZW50KSB7XG4gICAgICAvLyBBIGNsaWVudC1zaWRlIG9yIG5ldHdvcmsgZXJyb3Igb2NjdXJyZWQuIEhhbmRsZSBpdCBhY2NvcmRpbmdseS5cbiAgICAgIGVycm9yID0ge1xuICAgICAgICBtZXNzYWdlOiBlcnIuZXJyb3IsXG4gICAgICAgIHN0YXR1czogZXJyLnN0YXR1cyxcbiAgICAgICAgc3RhdHVzVGV4dDogZXJyLnN0YXR1c1RleHRcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRoZSBiYWNrZW5kIHJldHVybmVkIGFuIHVuc3VjY2Vzc2Z1bCByZXNwb25zZSBjb2RlLlxuICAgICAgLy8gVGhlIHJlc3BvbnNlIGJvZHkgbWF5IGNvbnRhaW4gY2x1ZXMgYXMgdG8gd2hhdCB3ZW50IHdyb25nLFxuICAgICAgZXJyb3IgPSB7XG4gICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgZXJyLmVycm9yIGluc3RhbmNlb2YgT2JqZWN0XG4gICAgICAgICAgICA/IGVyci5lcnJvci5tZXNzYWdlXG4gICAgICAgICAgICA6IGVyci5lcnJvciB8fCBlcnIubWVzc2FnZSxcbiAgICAgICAgc3RhdHVzOiBlcnIuc3RhdHVzLFxuICAgICAgICBzdGF0dXNUZXh0OiBlcnIuc3RhdHVzVGV4dFxuICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0QXBpUm9vdFVybChcbiAgICBpbmNsdWRlVmVyc2lvbk51bWJlcjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHByZWZlclByZXZpb3VzVmVyc2lvbjogYm9vbGVhbiA9IGZhbHNlXG4gICkge1xuICAgIGNvbnN0IHJvb3RVcmxQcm9taXNlID0gdGhpcy5tYW5pZmVzdFNlcnZpY2UuZ2V0Um9vdFVybCgpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAocm9vdFVybCA9PlxuICAgICAgICB0aGlzLnN5c3RlbUluZm9TZXJ2aWNlLmdldFN5c3RlbVZlcnNpb24oKS5waXBlKFxuICAgICAgICAgIG1hcCgodmVyc2lvbjogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICByb290VXJsLFxuICAgICAgICAgICAgICB2ZXJzaW9uOiB2ZXJzaW9uIC0gMSA8PSAyNSA/IHZlcnNpb24gKyAxIDogdmVyc2lvblxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICApXG4gICAgKTtcbiAgICByZXR1cm4gcm9vdFVybFByb21pc2UucGlwZShcbiAgICAgIG1hcChcbiAgICAgICAgKHVybEluZm86IHsgcm9vdFVybDogc3RyaW5nOyB2ZXJzaW9uOiBudW1iZXIgfSkgPT5cbiAgICAgICAgICBgJHt1cmxJbmZvLnJvb3RVcmx9YXBpLyR7XG4gICAgICAgICAgICBpbmNsdWRlVmVyc2lvbk51bWJlciAmJiAhcHJlZmVyUHJldmlvdXNWZXJzaW9uXG4gICAgICAgICAgICAgID8gdXJsSW5mby52ZXJzaW9uICsgJy8nXG4gICAgICAgICAgICAgIDogcHJlZmVyUHJldmlvdXNWZXJzaW9uXG4gICAgICAgICAgICAgICAgPyB1cmxJbmZvLnZlcnNpb25cbiAgICAgICAgICAgICAgICAgID8gdXJsSW5mby52ZXJzaW9uIC0gMSArICcvJ1xuICAgICAgICAgICAgICAgICAgOiAnJ1xuICAgICAgICAgICAgICAgIDogJydcbiAgICAgICAgICB9YFxuICAgICAgKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==