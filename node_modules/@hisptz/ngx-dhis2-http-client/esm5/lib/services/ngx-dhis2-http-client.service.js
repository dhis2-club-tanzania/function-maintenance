/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { ManifestService } from './manifest.service';
import { SystemInfoService } from './system-info.service';
import { throwError } from 'rxjs';
import { catchError, map, mergeMap, switchMap } from 'rxjs/internal/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./manifest.service";
import * as i3 from "./system-info.service";
var NgxDhis2HttpClientService = /** @class */ (function () {
    function NgxDhis2HttpClientService(httpClient, manifestService, systemInfoService) {
        this.httpClient = httpClient;
        this.manifestService = manifestService;
        this.systemInfoService = systemInfoService;
    }
    /**
     * @param {?} url
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype.get = /**
     * @param {?} url
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @return {?}
     */
    function (url, includeVersionNumber, preferPreviousApiVersion, useRootUrl) {
        var _this = this;
        if (includeVersionNumber === void 0) { includeVersionNumber = false; }
        if (preferPreviousApiVersion === void 0) { preferPreviousApiVersion = false; }
        if (useRootUrl === void 0) { useRootUrl = false; }
        var /** @type {?} */ rootUrlPromise = useRootUrl
            ? this.manifestService.getRootUrl()
            : this._getApiRootUrl(includeVersionNumber, preferPreviousApiVersion);
        return rootUrlPromise.pipe(mergeMap(function (rootUrl) {
            return _this.httpClient.get(rootUrl + url).pipe(catchError(_this._handleError));
        }), catchError(this._handleError));
    };
    /**
     * @param {?} url
     * @param {?} data
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @param {?=} headerOptions
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype.post = /**
     * @param {?} url
     * @param {?} data
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @param {?=} headerOptions
     * @return {?}
     */
    function (url, data, includeVersionNumber, preferPreviousApiVersion, useRootUrl, headerOptions) {
        var _this = this;
        if (includeVersionNumber === void 0) { includeVersionNumber = false; }
        if (preferPreviousApiVersion === void 0) { preferPreviousApiVersion = false; }
        if (useRootUrl === void 0) { useRootUrl = false; }
        var /** @type {?} */ rootUrlPromise = useRootUrl
            ? this.manifestService.getRootUrl()
            : this._getApiRootUrl(includeVersionNumber, preferPreviousApiVersion);
        return rootUrlPromise.pipe(mergeMap(function (rootUrl) {
            return _this.httpClient
                .post(rootUrl + url, data)
                .pipe(catchError(_this._handleError));
        }), catchError(this._handleError));
    };
    /**
     * @param {?} url
     * @param {?} data
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype.put = /**
     * @param {?} url
     * @param {?} data
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @return {?}
     */
    function (url, data, includeVersionNumber, preferPreviousApiVersion, useRootUrl) {
        var _this = this;
        if (includeVersionNumber === void 0) { includeVersionNumber = false; }
        if (preferPreviousApiVersion === void 0) { preferPreviousApiVersion = false; }
        if (useRootUrl === void 0) { useRootUrl = false; }
        var /** @type {?} */ rootUrlPromise = useRootUrl
            ? this.manifestService.getRootUrl()
            : this._getApiRootUrl(includeVersionNumber, preferPreviousApiVersion);
        return rootUrlPromise.pipe(mergeMap(function (rootUrl) {
            return _this.httpClient
                .put(rootUrl + url, data)
                .pipe(catchError(_this._handleError));
        }), catchError(this._handleError));
    };
    /**
     * @param {?} url
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype.delete = /**
     * @param {?} url
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousApiVersion
     * @param {?=} useRootUrl
     * @return {?}
     */
    function (url, includeVersionNumber, preferPreviousApiVersion, useRootUrl) {
        var _this = this;
        if (includeVersionNumber === void 0) { includeVersionNumber = false; }
        if (preferPreviousApiVersion === void 0) { preferPreviousApiVersion = false; }
        if (useRootUrl === void 0) { useRootUrl = false; }
        var /** @type {?} */ rootUrlPromise = useRootUrl
            ? this.manifestService.getRootUrl()
            : this._getApiRootUrl(includeVersionNumber, preferPreviousApiVersion);
        return rootUrlPromise.pipe(mergeMap(function (rootUrl) {
            return _this.httpClient
                .delete(rootUrl + url)
                .pipe(catchError(_this._handleError));
        }), catchError(this._handleError));
    };
    /**
     * @param {?} err
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype._handleError = /**
     * @param {?} err
     * @return {?}
     */
    function (err) {
        var /** @type {?} */ error = null;
        if (err.error instanceof ErrorEvent) {
            // A client-side or network error occurred. Handle it accordingly.
            error = {
                message: err.error,
                status: err.status,
                statusText: err.statusText
            };
        }
        else {
            // The backend returned an unsuccessful response code.
            // The response body may contain clues as to what went wrong,
            error = {
                message: err.error instanceof Object
                    ? err.error.message
                    : err.error || err.message,
                status: err.status,
                statusText: err.statusText
            };
        }
        return throwError(error);
    };
    /**
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousVersion
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype._getApiRootUrl = /**
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousVersion
     * @return {?}
     */
    function (includeVersionNumber, preferPreviousVersion) {
        var _this = this;
        if (includeVersionNumber === void 0) { includeVersionNumber = false; }
        if (preferPreviousVersion === void 0) { preferPreviousVersion = false; }
        var /** @type {?} */ rootUrlPromise = this.manifestService.getRootUrl().pipe(switchMap(function (rootUrl) {
            return _this.systemInfoService.getSystemVersion().pipe(map(function (version) {
                return {
                    rootUrl: rootUrl,
                    version: version - 1 <= 25 ? version + 1 : version
                };
            }));
        }));
        return rootUrlPromise.pipe(map(function (urlInfo) {
            return urlInfo.rootUrl + "api/" + (includeVersionNumber && !preferPreviousVersion
                ? urlInfo.version + '/'
                : preferPreviousVersion
                    ? urlInfo.version
                        ? urlInfo.version - 1 + '/'
                        : ''
                    : '');
        }));
    };
    NgxDhis2HttpClientService.decorators = [
        { type: Injectable, args: [{ providedIn: 'root' },] },
    ];
    /** @nocollapse */
    NgxDhis2HttpClientService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: ManifestService },
        { type: SystemInfoService }
    ]; };
    /** @nocollapse */ NgxDhis2HttpClientService.ngInjectableDef = i0.defineInjectable({ factory: function NgxDhis2HttpClientService_Factory() { return new NgxDhis2HttpClientService(i0.inject(i1.HttpClient), i0.inject(i2.ManifestService), i0.inject(i3.SystemInfoService)); }, token: NgxDhis2HttpClientService, providedIn: "root" });
    return NgxDhis2HttpClientService;
}());
export { NgxDhis2HttpClientService };
function NgxDhis2HttpClientService_tsickle_Closure_declarations() {
    /** @type {?} */
    NgxDhis2HttpClientService.prototype.httpClient;
    /** @type {?} */
    NgxDhis2HttpClientService.prototype.manifestService;
    /** @type {?} */
    NgxDhis2HttpClientService.prototype.systemInfoService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWRoaXMyLWh0dHAtY2xpZW50LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AaGlzcHR6L25neC1kaGlzMi1odHRwLWNsaWVudC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9uZ3gtZGhpczItaHR0cC1jbGllbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFxQixNQUFNLHNCQUFzQixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQWMsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQzs7Ozs7O0lBSTdFLG1DQUNVLFlBQ0EsaUJBQ0E7UUFGQSxlQUFVLEdBQVYsVUFBVTtRQUNWLG9CQUFlLEdBQWYsZUFBZTtRQUNmLHNCQUFpQixHQUFqQixpQkFBaUI7S0FDdkI7Ozs7Ozs7O0lBRUosdUNBQUc7Ozs7Ozs7SUFBSCxVQUNFLEdBQVcsRUFDWCxvQkFBcUMsRUFDckMsd0JBQXlDLEVBQ3pDLFVBQTJCO1FBSjdCLGlCQWdCQztRQWRDLHFDQUFBLEVBQUEsNEJBQXFDO1FBQ3JDLHlDQUFBLEVBQUEsZ0NBQXlDO1FBQ3pDLDJCQUFBLEVBQUEsa0JBQTJCO1FBRTNCLHFCQUFNLGNBQWMsR0FBRyxVQUFVO1lBQy9CLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRTtZQUNuQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxvQkFBb0IsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO1FBRXhFLE1BQU0sQ0FBQyxjQUFjLENB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QUFNLENBQUM7b0JBQ0wsT0FBTyxTQUFBO29CQUNQLE9BQU8sRUFBRSxPQUFPLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTztpQkFDbkQsQ0FBQzthQUNILENBQUMsQ0FDSDtRQVBELENBT0MsQ0FDRixDQUNGLENBQUM7UUFDRixNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FDeEIsR0FBRyxDQUNELFVBQUMsT0FBNkM7WUFDNUMsT0FBRyxPQUFPLENBQUMsT0FBTyxhQUNoQixvQkFBb0IsSUFBSSxDQUFDLHFCQUFxQjtnQkFDNUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsR0FBRztnQkFDdkIsQ0FBQyxDQUFDLHFCQUFxQjtvQkFDckIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPO3dCQUNmLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxHQUFHLENBQUMsR0FBRyxHQUFHO3dCQUMzQixDQUFDLENBQUMsRUFBRTtvQkFDTixDQUFDLENBQUMsRUFBRSxDQUNSO1FBUkYsQ0FRRSxDQUNMLENBQ0YsQ0FBQzs7O2dCQTlJTCxVQUFVLFNBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFOzs7O2dCQU56QixVQUFVO2dCQUNWLGVBQWU7Z0JBQ2YsaUJBQWlCOzs7b0NBSDFCOztTQVFhLHlCQUF5QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBFcnJvclJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgTWFuaWZlc3RTZXJ2aWNlIH0gZnJvbSAnLi9tYW5pZmVzdC5zZXJ2aWNlJztcbmltcG9ydCB7IFN5c3RlbUluZm9TZXJ2aWNlIH0gZnJvbSAnLi9zeXN0ZW0taW5mby5zZXJ2aWNlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIG1hcCwgbWVyZ2VNYXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvaW50ZXJuYWwvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBOZ3hEaGlzMkh0dHBDbGllbnRTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LFxuICAgIHByaXZhdGUgbWFuaWZlc3RTZXJ2aWNlOiBNYW5pZmVzdFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBzeXN0ZW1JbmZvU2VydmljZTogU3lzdGVtSW5mb1NlcnZpY2VcbiAgKSB7fVxuXG4gIGdldChcbiAgICB1cmw6IHN0cmluZyxcbiAgICBpbmNsdWRlVmVyc2lvbk51bWJlcjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHByZWZlclByZXZpb3VzQXBpVmVyc2lvbjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHVzZVJvb3RVcmw6IGJvb2xlYW4gPSBmYWxzZVxuICApOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHJvb3RVcmxQcm9taXNlID0gdXNlUm9vdFVybFxuICAgICAgPyB0aGlzLm1hbmlmZXN0U2VydmljZS5nZXRSb290VXJsKClcbiAgICAgIDogdGhpcy5fZ2V0QXBpUm9vdFVybChpbmNsdWRlVmVyc2lvbk51bWJlciwgcHJlZmVyUHJldmlvdXNBcGlWZXJzaW9uKTtcblxuICAgIHJldHVybiByb290VXJsUHJvbWlzZS5waXBlKFxuICAgICAgbWVyZ2VNYXAocm9vdFVybCA9PlxuICAgICAgICB0aGlzLmh0dHBDbGllbnQuZ2V0KHJvb3RVcmwgKyB1cmwpLnBpcGUoY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcikpXG4gICAgICApLFxuICAgICAgY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcilcbiAgICApO1xuICB9XG5cbiAgcG9zdChcbiAgICB1cmw6IHN0cmluZyxcbiAgICBkYXRhOiBhbnksXG4gICAgaW5jbHVkZVZlcnNpb25OdW1iZXI6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBwcmVmZXJQcmV2aW91c0FwaVZlcnNpb246IGJvb2xlYW4gPSBmYWxzZSxcbiAgICB1c2VSb290VXJsOiBib29sZWFuID0gZmFsc2UsXG4gICAgaGVhZGVyT3B0aW9ucz86IGFueVxuICApIHtcbiAgICBjb25zdCByb290VXJsUHJvbWlzZSA9IHVzZVJvb3RVcmxcbiAgICAgID8gdGhpcy5tYW5pZmVzdFNlcnZpY2UuZ2V0Um9vdFVybCgpXG4gICAgICA6IHRoaXMuX2dldEFwaVJvb3RVcmwoaW5jbHVkZVZlcnNpb25OdW1iZXIsIHByZWZlclByZXZpb3VzQXBpVmVyc2lvbik7XG4gICAgcmV0dXJuIHJvb3RVcmxQcm9taXNlLnBpcGUoXG4gICAgICBtZXJnZU1hcChyb290VXJsID0+XG4gICAgICAgIHRoaXMuaHR0cENsaWVudFxuICAgICAgICAgIC5wb3N0KHJvb3RVcmwgKyB1cmwsIGRhdGEpXG4gICAgICAgICAgLnBpcGUoY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcikpXG4gICAgICApLFxuICAgICAgY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcilcbiAgICApO1xuICB9XG5cbiAgcHV0KFxuICAgIHVybDogc3RyaW5nLFxuICAgIGRhdGE6IGFueSxcbiAgICBpbmNsdWRlVmVyc2lvbk51bWJlcjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHByZWZlclByZXZpb3VzQXBpVmVyc2lvbjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHVzZVJvb3RVcmw6IGJvb2xlYW4gPSBmYWxzZVxuICApIHtcbiAgICBjb25zdCByb290VXJsUHJvbWlzZSA9IHVzZVJvb3RVcmxcbiAgICAgID8gdGhpcy5tYW5pZmVzdFNlcnZpY2UuZ2V0Um9vdFVybCgpXG4gICAgICA6IHRoaXMuX2dldEFwaVJvb3RVcmwoaW5jbHVkZVZlcnNpb25OdW1iZXIsIHByZWZlclByZXZpb3VzQXBpVmVyc2lvbik7XG5cbiAgICByZXR1cm4gcm9vdFVybFByb21pc2UucGlwZShcbiAgICAgIG1lcmdlTWFwKHJvb3RVcmwgPT5cbiAgICAgICAgdGhpcy5odHRwQ2xpZW50XG4gICAgICAgICAgLnB1dChyb290VXJsICsgdXJsLCBkYXRhKVxuICAgICAgICAgIC5waXBlKGNhdGNoRXJyb3IodGhpcy5faGFuZGxlRXJyb3IpKVxuICAgICAgKSxcbiAgICAgIGNhdGNoRXJyb3IodGhpcy5faGFuZGxlRXJyb3IpXG4gICAgKTtcbiAgfVxuXG4gIGRlbGV0ZShcbiAgICB1cmw6IHN0cmluZyxcbiAgICBpbmNsdWRlVmVyc2lvbk51bWJlcjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHByZWZlclByZXZpb3VzQXBpVmVyc2lvbjogYm9vbGVhbiA9IGZhbHNlLFxuICAgIHVzZVJvb3RVcmw6IGJvb2xlYW4gPSBmYWxzZVxuICApIHtcbiAgICBjb25zdCByb290VXJsUHJvbWlzZSA9IHVzZVJvb3RVcmxcbiAgICAgID8gdGhpcy5tYW5pZmVzdFNlcnZpY2UuZ2V0Um9vdFVybCgpXG4gICAgICA6IHRoaXMuX2dldEFwaVJvb3RVcmwoaW5jbHVkZVZlcnNpb25OdW1iZXIsIHByZWZlclByZXZpb3VzQXBpVmVyc2lvbik7XG5cbiAgICByZXR1cm4gcm9vdFVybFByb21pc2UucGlwZShcbiAgICAgIG1lcmdlTWFwKHJvb3RVcmwgPT5cbiAgICAgICAgdGhpcy5odHRwQ2xpZW50XG4gICAgICAgICAgLmRlbGV0ZShyb290VXJsICsgdXJsKVxuICAgICAgICAgIC5waXBlKGNhdGNoRXJyb3IodGhpcy5faGFuZGxlRXJyb3IpKVxuICAgICAgKSxcbiAgICAgIGNhdGNoRXJyb3IodGhpcy5faGFuZGxlRXJyb3IpXG4gICAgKTtcbiAgfVxuXG4gIC8vIHByaXZhdGUgbWV0aG9kc1xuICBwcml2YXRlIF9oYW5kbGVFcnJvcihlcnI6IEh0dHBFcnJvclJlc3BvbnNlKSB7XG4gICAgbGV0IGVycm9yID0gbnVsbDtcbiAgICBpZiAoZXJyLmVycm9yIGluc3RhbmNlb2YgRXJyb3JFdmVudCkge1xuICAgICAgLy8gQSBjbGllbnQtc2lkZSBvciBuZXR3b3JrIGVycm9yIG9jY3VycmVkLiBIYW5kbGUgaXQgYWNjb3JkaW5nbHkuXG4gICAgICBlcnJvciA9IHtcbiAgICAgICAgbWVzc2FnZTogZXJyLmVycm9yLFxuICAgICAgICBzdGF0dXM6IGVyci5zdGF0dXMsXG4gICAgICAgIHN0YXR1c1RleHQ6IGVyci5zdGF0dXNUZXh0XG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBUaGUgYmFja2VuZCByZXR1cm5lZCBhbiB1bnN1Y2Nlc3NmdWwgcmVzcG9uc2UgY29kZS5cbiAgICAgIC8vIFRoZSByZXNwb25zZSBib2R5IG1heSBjb250YWluIGNsdWVzIGFzIHRvIHdoYXQgd2VudCB3cm9uZyxcbiAgICAgIGVycm9yID0ge1xuICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgIGVyci5lcnJvciBpbnN0YW5jZW9mIE9iamVjdFxuICAgICAgICAgICAgPyBlcnIuZXJyb3IubWVzc2FnZVxuICAgICAgICAgICAgOiBlcnIuZXJyb3IgfHwgZXJyLm1lc3NhZ2UsXG4gICAgICAgIHN0YXR1czogZXJyLnN0YXR1cyxcbiAgICAgICAgc3RhdHVzVGV4dDogZXJyLnN0YXR1c1RleHRcbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yKTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldEFwaVJvb3RVcmwoXG4gICAgaW5jbHVkZVZlcnNpb25OdW1iZXI6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBwcmVmZXJQcmV2aW91c1ZlcnNpb246IGJvb2xlYW4gPSBmYWxzZVxuICApIHtcbiAgICBjb25zdCByb290VXJsUHJvbWlzZSA9IHRoaXMubWFuaWZlc3RTZXJ2aWNlLmdldFJvb3RVcmwoKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKHJvb3RVcmwgPT5cbiAgICAgICAgdGhpcy5zeXN0ZW1JbmZvU2VydmljZS5nZXRTeXN0ZW1WZXJzaW9uKCkucGlwZShcbiAgICAgICAgICBtYXAoKHZlcnNpb246IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgcm9vdFVybCxcbiAgICAgICAgICAgICAgdmVyc2lvbjogdmVyc2lvbiAtIDEgPD0gMjUgPyB2ZXJzaW9uICsgMSA6IHZlcnNpb25cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICk7XG4gICAgcmV0dXJuIHJvb3RVcmxQcm9taXNlLnBpcGUoXG4gICAgICBtYXAoXG4gICAgICAgICh1cmxJbmZvOiB7IHJvb3RVcmw6IHN0cmluZzsgdmVyc2lvbjogbnVtYmVyIH0pID0+XG4gICAgICAgICAgYCR7dXJsSW5mby5yb290VXJsfWFwaS8ke1xuICAgICAgICAgICAgaW5jbHVkZVZlcnNpb25OdW1iZXIgJiYgIXByZWZlclByZXZpb3VzVmVyc2lvblxuICAgICAgICAgICAgICA/IHVybEluZm8udmVyc2lvbiArICcvJ1xuICAgICAgICAgICAgICA6IHByZWZlclByZXZpb3VzVmVyc2lvblxuICAgICAgICAgICAgICAgID8gdXJsSW5mby52ZXJzaW9uXG4gICAgICAgICAgICAgICAgICA/IHVybEluZm8udmVyc2lvbiAtIDEgKyAnLydcbiAgICAgICAgICAgICAgICAgIDogJydcbiAgICAgICAgICAgICAgICA6ICcnXG4gICAgICAgICAgfWBcbiAgICAgIClcbiAgICApO1xuICB9XG59XG4iXX0=